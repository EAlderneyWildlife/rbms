<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculating phenology and collated indices with rbms • rbms</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/flatly/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Calculating phenology and collated indices with rbms">
<meta property="og:description" content="rbms">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-154857767-2"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-154857767-2');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">rbms</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/vignette.html">Calculating phenology and collated indices with rbms</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/RetoSchmucki/rbms/" class="external-link">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Calculating phenology and collated indices with
rbms</h1>
            <h3 data-toc-skip class="subtitle">From counts to flight
curve to collated indices</h3>
                        <h4 data-toc-skip class="author">Reto Schmucki
(UKCEH) &amp; Dylan Carbone</h4>
            
            <h4 data-toc-skip class="date">23rd of July 2024</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/RetoSchmucki/rbms/blob/HEAD/vignettes/vignette.Rmd" class="external-link"><code>vignettes/vignette.Rmd</code></a></small>
      <div class="hidden name"><code>vignette.Rmd</code></div>

    </div>

    
    
<p>The <code>rbms</code> package allows users to derive species
phenology and estimate abundances of butterfly species. In this
tutorial, we use R functions implemented in the <code>rbms</code>
package to produce the following key outputs:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Compute a flight curve</strong>: A spline fitted curve,
representing the activity of the species within the monitoring season.
The flight curve computation is based on a spline fitted on the counts
collected across multiple sites and standardised to sum to 1 (area under
the curve is one).</li>
<li>
<strong>Site indices and annual collated indices</strong>: The
yearly abundance at each site, and a model estimate of yearly abundance
across all sites.</li>
</ol>
<p>Pre-requisite steps include the construction of a time series and
imputation of counts from the flight curve when abundance data is
missing.</p>
<p>The data used in this vignette are bundled within the package and are
from genuine Butterfly Monitoring Scheme surveys.</p>
<div class="section level2">
<h2 id="setup">1. Setup<a class="anchor" aria-label="anchor" href="#setup"></a>
</h2>
<p>First, install and load required packages.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install required packages</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"remotes"</span><span class="op">)</span> <span class="co"># To install R packages from github</span></span></code></pre></div>
<pre><code><span><span class="co">## Installing package into 'C:/Users/retoschm/AppData/Local/Temp/Rtmp8KZU6U/temp_libpath4570d72b51'</span></span>
<span><span class="co">## (as 'lib' is unspecified)</span></span></code></pre>
<pre><code><span><span class="co">## package 'remotes' successfully unpacked and MD5 sums checked</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## The downloaded binary packages are in</span></span>
<span><span class="co">##  C:\Users\retoschm\AppData\Local\Temp\RtmpIdddvC\downloaded_packages</span></span></code></pre>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/install.packages.html" class="external-link">install.packages</a></span><span class="op">(</span><span class="st">"ggplot2"</span><span class="op">)</span> <span class="co"># to generate plots in this tutorial</span></span></code></pre></div>
<pre><code><span><span class="co">## Installing package into 'C:/Users/retoschm/AppData/Local/Temp/Rtmp8KZU6U/temp_libpath4570d72b51'</span></span>
<span><span class="co">## (as 'lib' is unspecified)</span></span></code></pre>
<pre><code><span><span class="co">## package 'ggplot2' successfully unpacked and MD5 sums checked</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## The downloaded binary packages are in</span></span>
<span><span class="co">##  C:\Users\retoschm\AppData\Local\Temp\RtmpIdddvC\downloaded_packages</span></span></code></pre>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Install rbms from github</span></span>
<span><span class="co"># remotes::install_github("https://github.com/RetoSchmucki/rbms.git")</span></span>
<span></span>
<span><span class="co"># Load rbms and ggplot2</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://retoschmucki.github.io/rbms/" class="external-link">rbms</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##  Welcome to rbms, version 1.1.3 </span></span>
<span><span class="co">##  This package has been tested, but is still in active development and feedbacks are welcome</span></span>
<span><span class="co">##  https://github.com/RetoSchmucki/rbms/issues</span></span></code></pre>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: package 'ggplot2' was built under R version 4.4.1</span></span></code></pre>
<p>Then load the bundled butterfly monitoring scheme data bundled with
the rbms package.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">m_visit</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">m_count</span><span class="op">)</span></span></code></pre></div>
<p><strong>The header names of the visit and count data need to be
consistent, and all columns present in the data loaded for this tutorial
need to be present in your data for the functions to work.</strong></p>
<p>Visit data represents the date at which each monitoring site was
visited. If no butterfly was observed during a visit, the abundance for
that specific visit would be set to zero. This allows to subset positive
non-zero counts from the count data set, which result in smaller objects
to handle. The visit data may contain many columns, but only two are
essential for the function.</p>
<p><em>NOTE: Visit and count data are provided in data.table format, and
likewise data.table syntax is used for many of the data processing steps
in this tutorial. Whilst other formats and packages are acceptable, it
is recommended for larger datasets that you continue to use data.table,
as it is efficient for handling large data sets</em></p>
<ol style="list-style-type: decimal">
<li>
<strong>SITE_ID</strong> (can be numbers of characters and treated
as a non-numeric factor)</li>
<li>
<strong>DATE</strong> (by default, the format is “%Y-%m-%d” (e.g.,
2019-11-28]). If a different format needs to be specified, use the
argument DateFormat)</li>
</ol>
<pre><code><span><span class="co">##        SITE_ID       DATE</span></span>
<span><span class="co">##          &lt;int&gt;     &lt;char&gt;</span></span>
<span><span class="co">##     1:       1 2000-04-07</span></span>
<span><span class="co">##     2:       1 2000-04-19</span></span>
<span><span class="co">##     3:       1 2000-05-12</span></span>
<span><span class="co">##     4:       1 2000-05-15</span></span>
<span><span class="co">##     5:       1 2000-05-24</span></span>
<span><span class="co">##    ---                   </span></span>
<span><span class="co">## 12136:     193 2004-08-19</span></span>
<span><span class="co">## 12137:     193 2004-08-31</span></span>
<span><span class="co">## 12138:     193 2004-09-04</span></span>
<span><span class="co">## 12139:     193 2004-09-15</span></span>
<span><span class="co">## 12140:     193 2004-09-28</span></span></code></pre>
<p>Count data must be provided in columns with specific headers; more
column can be provided, but rbms only use the following four:</p>
<ol style="list-style-type: decimal">
<li><strong>SITE_ID</strong></li>
<li><strong>DATE</strong></li>
<li><strong>SPECIES</strong></li>
<li><strong>COUNT</strong></li>
</ol>
<pre><code><span><span class="co">##       SITE_ID       DATE SPECIES   DAY MONTH  YEAR COUNT</span></span>
<span><span class="co">##         &lt;int&gt;     &lt;char&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;</span></span>
<span><span class="co">##    1:       1 2000-04-07       2     7     4  2000     5</span></span>
<span><span class="co">##    2:       1 2000-04-19       2    19     4  2000     3</span></span>
<span><span class="co">##    3:       1 2000-05-12       2    12     5  2000     1</span></span>
<span><span class="co">##    4:       1 2000-05-12       4    12     5  2000     2</span></span>
<span><span class="co">##    5:       1 2000-05-15       4    15     5  2000     4</span></span>
<span><span class="co">##   ---                                                   </span></span>
<span><span class="co">## 5303:     193 2003-09-06       2     6     9  2003     1</span></span>
<span><span class="co">## 5304:     193 2004-04-23       2    23     4  2004     2</span></span>
<span><span class="co">## 5305:     193 2004-05-02       2     2     5  2004     1</span></span>
<span><span class="co">## 5306:     193 2004-06-19       2    19     6  2004     2</span></span>
<span><span class="co">## 5307:     193 2004-07-10       2    10     7  2004     1</span></span></code></pre>
<div class="section level5">
<h5 id="organise-the-data-to-cover-the-time-period-and-monitoring-season-of-the-bms">
<strong>2.</strong> organise the data to cover the time period and
monitoring season of the BMS<a class="anchor" aria-label="anchor" href="#organise-the-data-to-cover-the-time-period-and-monitoring-season-of-the-bms"></a>
</h5>
<p>Using the visit and count data, we need to create a new data.table
object representing a time series. We initialise the time-series,
specifying the start and end year of the monitoring season, with entries
at a weekly or daily basis (the resolution of the flight curve). In a
first step, we initialise the time-series with an initial year with the
InitYear argument, and end year with the LastYear argument. We also
specify the first day of the week with the WeekDay1 argument as either
‘sunday’ or ‘monday’.</p>
<p><strong>2.1.</strong> First, we initialise a time-series with
day-week-month-year information.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ts_date</span> <span class="op">&lt;-</span> <span class="fu">rbms</span><span class="fu">::</span><span class="fu"><a href="../reference/ts_dwmy_table.html">ts_dwmy_table</a></span><span class="op">(</span>InitYear <span class="op">=</span> <span class="fl">2000</span>, LastYear <span class="op">=</span> <span class="fl">2003</span>, WeekDay1 <span class="op">=</span> <span class="st">'monday'</span><span class="op">)</span></span></code></pre></div>
<p><strong>2.2.</strong> Add the monitoring season to the
time-series</p>
<p>We build upon the time series with the monitoring season, providing
the StartMonth and EndMonth arguments. The definition of the monitoring
season can be refined with more arguments of the start and end date
(StartDay, EndDay). We also define the resolution of the time-series as
weekly using the Timeunit argument (<code>w</code> or <code>d</code> for
weekly or daily records). The ANCHOR argument adds zeros before and
after the monitoring season, to ensure that the flight curve starts and
ends at zero.</p>
<p><em>NOTE: For species with overwintering adult and early counts,
having an Anchor set to zero might sound wrong, and we are currently
working on finding an alternative for these cases to represent the
flight curve of those species better.</em></p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ts_season</span> <span class="op">&lt;-</span> <span class="fu">rbms</span><span class="fu">::</span><span class="fu"><a href="../reference/ts_monit_season.html">ts_monit_season</a></span><span class="op">(</span><span class="va">ts_date</span>, StartMonth <span class="op">=</span> <span class="fl">4</span>, EndMonth <span class="op">=</span> <span class="fl">9</span>, StartDay <span class="op">=</span> <span class="fl">1</span>, EndDay <span class="op">=</span> <span class="cn">NULL</span>, CompltSeason <span class="op">=</span> <span class="cn">TRUE</span>, Anchor <span class="op">=</span> <span class="cn">TRUE</span>, AnchorLength <span class="op">=</span> <span class="fl">2</span>, AnchorLag <span class="op">=</span> <span class="fl">2</span>, TimeUnit <span class="op">=</span> <span class="st">'w'</span><span class="op">)</span></span></code></pre></div>
<p><strong>2.3.</strong> Add site visits to the time-series</p>
<p>Now that the monitoring season has been defined, we use the
<code><a href="../reference/ts_monit_site.html">ts_monit_site()</a></code> function to integrate the time-series with
the site visits. We use the visit data and link it with the time series
contained in ts_season object.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ts_season_visit</span> <span class="op">&lt;-</span> <span class="fu">rbms</span><span class="fu">::</span><span class="fu"><a href="../reference/ts_monit_site.html">ts_monit_site</a></span><span class="op">(</span><span class="va">ts_season</span>, <span class="va">m_visit</span><span class="op">)</span></span></code></pre></div>
<p><strong>2.4.</strong> Add observed count</p>
<p>The time-series is next integrated with the count data. Here we must
specify the focus species in the sp argument, providing either an
integer (we have used 2 here), or a string.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">ts_season_count</span> <span class="op">&lt;-</span> <span class="fu">rbms</span><span class="fu">::</span><span class="fu"><a href="../reference/ts_monit_count_site.html">ts_monit_count_site</a></span><span class="op">(</span><span class="va">ts_season_visit</span>, <span class="va">m_count</span>, sp <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<p>The resulting <code>data.table</code> object contains zeros and
positive counts recorded along each BMS transects for species 2, over
the entire time-series, but only within the focal monitoring season.
When the counts are missing because the site was not visited, the count
is informed as NA.</p>
<pre><code><span><span class="co">## Key: &lt;DATE, SITE_ID&gt;</span></span>
<span><span class="co">## Index: &lt;ANCHOR__M_SEASON&gt;</span></span>
<span><span class="co">##         M_YEAR       DATE DAY_SINCE  YEAR MONTH   DAY  WEEK WEEK_SINCE WEEK_DAY</span></span>
<span><span class="co">##         &lt;fctr&gt;     &lt;IDat&gt;     &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;      &lt;num&gt;    &lt;num&gt;</span></span>
<span><span class="co">##      1:   2000 2000-01-01         1  2000     1     1    52          1        6</span></span>
<span><span class="co">##      2:   2000 2000-01-01         1  2000     1     1    52          1        6</span></span>
<span><span class="co">##      3:   2000 2000-01-01         1  2000     1     1    52          1        6</span></span>
<span><span class="co">##      4:   2000 2000-01-01         1  2000     1     1    52          1        6</span></span>
<span><span class="co">##      5:   2000 2000-01-01         1  2000     1     1    52          1        6</span></span>
<span><span class="co">##     ---                                                                        </span></span>
<span><span class="co">## 173496:   2003 2003-12-31      1461  2003    12    31     1        210        3</span></span>
<span><span class="co">## 173497:   2003 2003-12-31      1461  2003    12    31     1        210        3</span></span>
<span><span class="co">## 173498:   2003 2003-12-31      1461  2003    12    31     1        210        3</span></span>
<span><span class="co">## 173499:   2003 2003-12-31      1461  2003    12    31     1        210        3</span></span>
<span><span class="co">## 173500:   2003 2003-12-31      1461  2003    12    31     1        210        3</span></span>
<span><span class="co">##         M_SEASON COMPLT_SEASON ANCHOR COUNT SITE_ID SPECIES</span></span>
<span><span class="co">##            &lt;num&gt;         &lt;int&gt;  &lt;int&gt; &lt;int&gt;   &lt;int&gt;   &lt;num&gt;</span></span>
<span><span class="co">##      1:        0             1      0    NA       1       2</span></span>
<span><span class="co">##      2:        0             1      0    NA       2       2</span></span>
<span><span class="co">##      3:        0             1      0    NA       3       2</span></span>
<span><span class="co">##      4:        0             1      0    NA       4       2</span></span>
<span><span class="co">##      5:        0             1      0    NA       6       2</span></span>
<span><span class="co">##     ---                                                    </span></span>
<span><span class="co">## 173496:        0             1      0    NA     184       2</span></span>
<span><span class="co">## 173497:        0             1      0    NA     185       2</span></span>
<span><span class="co">## 173498:        0             1      0    NA     186       2</span></span>
<span><span class="co">## 173499:        0             1      0    NA     187       2</span></span>
<span><span class="co">## 173500:        0             1      0    NA     193       2</span></span></code></pre>
</div>
<div class="section level5">
<h5 id="compute-the-yearly-flight-curve-for-the-data">
<strong>3.</strong> Compute the yearly flight curve for the
data<a class="anchor" aria-label="anchor" href="#compute-the-yearly-flight-curve-for-the-data"></a>
</h5>
<p>With the time season data prepared and saved under ts_season_count,
can compute the flight curve, representing the species phenology.</p>
<p>we can compute the flight curve for each year by using the
<code>flight_curve</code> function. First we want to impose some minimal
threshold to control the quality of the data used to inform this model.
This is done by setting the Minimum number of visits (MinNbrVisit), the
minimum number of occurrences (MinOccur) and the number of sites
(MinNbrSite) to use to fit the model. These values can influence the
model, and its sensitivity will depend on the species and the dataset.
Still, as a minimum requirement, MinOccur should be set &gt;= 2, the
MinNbrVisit &gt; MinOccur and MinNbrSite &gt;= 5. These thresholds
affect the data that inform your model and the resulting flight curve.
When higher values are chosen, fewer sites will be available and if
insufficient, the thresholds need to be revised.</p>
<p><em>NOTE: The <code>flight_curve</code> function assumes that species
phenology is the same across sites. The sample size of the data must be
large enough to calculate the flight_curve</em></p>
<p><em>You will also have to define some parameters for the distribution
for the GAM model as well as the maximum number of times to try to fit
the model and the number of samples to use. The later will take a random
sample from the data set if it contains more sites than the number
specified.</em></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span> <span class="va">ts_flight_curve</span> <span class="op">&lt;-</span> <span class="fu">rbms</span><span class="fu">::</span><span class="fu"><a href="../reference/flight_curve.html">flight_curve</a></span><span class="op">(</span><span class="va">ts_season_count</span>, NbrSample <span class="op">=</span> <span class="fl">300</span>, MinVisit <span class="op">=</span> <span class="fl">5</span>, MinOccur <span class="op">=</span> <span class="fl">3</span>, MinNbrSite <span class="op">=</span> <span class="fl">5</span>, MaxTrial <span class="op">=</span> <span class="fl">4</span>, GamFamily <span class="op">=</span> <span class="st">'nb'</span>, SpeedGam <span class="op">=</span> <span class="cn">FALSE</span>, CompltSeason <span class="op">=</span> <span class="cn">TRUE</span>, SelectYear <span class="op">=</span> <span class="cn">NULL</span>, TimeUnit <span class="op">=</span> <span class="st">'w'</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Fitting the flight curve spline for species 2 and year 2000 with 76 sites, using gam() : 2024-08-20 15:07:17.913829 -&gt; trial 1</span></span></code></pre>
<pre><code><span><span class="co">## Fitting the flight curve spline for species 2 and year 2001 with 76 sites, using gam() : 2024-08-20 15:07:19.152067 -&gt; trial 1</span></span></code></pre>
<pre><code><span><span class="co">## Fitting the flight curve spline for species 2 and year 2002 with 87 sites, using gam() : 2024-08-20 15:07:19.660446 -&gt; trial 1</span></span></code></pre>
<pre><code><span><span class="co">## Fitting the flight curve spline for species 2 and year 2003 with 103 sites, using gam() : 2024-08-20 15:07:20.654046 -&gt; trial 1</span></span></code></pre>
<p>We are given a list of 3 elements as an output of the
<code><a href="../reference/flight_curve.html">flight_curve()</a></code> function:</p>
<ul>
<li>pheno: The standardised phenology curve derived by fitting a GAM
model, with a cubic spline to the count data;</li>
<li>model: The result of the fitted GAM model;</li>
<li>data: The data used to fit the GAM model.</li>
</ul>
<p>We can now extract the pheno object, a data.frame that contains the
shape of the annual flight curves, standardised to sum to 1. The
flight-curves contained in the pheno object can be visualised with the
following line of codes.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Extract the phenology output</span></span>
<span><span class="va">pheno</span> <span class="op">&lt;-</span> <span class="va">ts_flight_curve</span><span class="op">$</span><span class="va">pheno</span></span>
<span></span>
<span><span class="co"># Determine if 'trimWEEKNO' exists and set the appropriate x-axis variable</span></span>
<span><span class="va">x_var</span> <span class="op">&lt;-</span> <span class="kw">if</span><span class="op">(</span><span class="st">"trimWEEKNO"</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">pheno</span><span class="op">)</span><span class="op">)</span><span class="op">{</span><span class="st">"trimWEEKNO"</span><span class="op">}</span> <span class="kw">else</span> <span class="op">{</span><span class="st">"trimDAYNO"</span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Create the ggplot</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">pheno</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">.data</span><span class="op">[[</span><span class="va">x_var</span><span class="op">]</span><span class="op">]</span>, y <span class="op">=</span> <span class="va">NM</span>, color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">M_YEAR</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_colour_discrete.html" class="external-link">scale_color_discrete</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Year"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">x_var</span> <span class="op">==</span> <span class="st">"trimWEEKNO"</span>, <span class="st">"Monitoring Week"</span>, <span class="st">"Monitoring Day"</span><span class="op">)</span>,</span>
<span>       y <span class="op">=</span> <span class="st">"Relative Abundance"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"top"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="vignette_files/figure-html/fc-1.png" alt="Flight curve." width="700"><p class="caption">
Flight curve.
</p>
</div>
</div>
<div class="section level5">
<h5 id="impute-predicted-counts-for-missing-monitoring-dates">
<strong>4.</strong> Impute predicted counts for missing monitoring
dates<a class="anchor" aria-label="anchor" href="#impute-predicted-counts-for-missing-monitoring-dates"></a>
</h5>
<p>From the flight curve and the observed counts, we can derive expected
values for weeks or days where a site has not been monitored. Together,
observed and imputed counts are used to compute abundance indices across
sites. Site indices are then used to calculate annual collated
indices.</p>
<p>The <code><a href="../reference/impute_count.html">impute_count()</a></code> function uses the time season data
prepared and saved under ts_season_count, and the flight curves in the
pheno output of the <code><a href="../reference/flight_curve.html">flight_curve()</a></code> function. The
<code><a href="../reference/impute_count.html">impute_count()</a></code> function looks for the phenology available
(using the nearest year) to estimate and input missing values. The
extent of the search for nearest phenology can be limited by setting the
YearLimit argument. By default, this is not restricted and will look
over all years available.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Impute the count estimates</span></span>
<span><span class="co"># Note that the pheno element is extracted automatically from the ts_flight_curve object</span></span>
<span><span class="va">impt_counts</span> <span class="op">&lt;-</span> <span class="fu">rbms</span><span class="fu">::</span><span class="fu"><a href="../reference/impute_count.html">impute_count</a></span><span class="op">(</span>ts_season_count<span class="op">=</span><span class="va">ts_season_count</span>, ts_flight_curve<span class="op">=</span><span class="va">ts_flight_curve</span>, YearLimit<span class="op">=</span> <span class="cn">NULL</span>, TimeUnit<span class="op">=</span><span class="st">'w'</span><span class="op">)</span></span></code></pre></div>
<p>The <code><a href="../reference/impute_count.html">impute_count()</a></code> function produces a data.table that
includes the following columns: COUNT: The original count values.
IMPUTED_COUNT: An estimate of the count in the event that there is no
recording of count (I.E., the original count is NA). The imputed count
is derived from the flight curve. If the original count is present, the
imputed count is set as equal to the original count. TOTAL_COUNT: The
sum of the Imputed count within the site and year. SINDEX: The sum of
the imputed counts over the sampling season. If the flight curve of a
specific year is missing, the <code><a href="../reference/impute_count.html">impute_count()</a></code> function uses
the nearest phenology found. If none are available within the limit of
years set by the YearLimit argument, the function will return no SINDEX
for that specific year. TOTAL_NM: The proportion of the flight curve
covered by the visits. This is the total count divided by the site
index.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">impt_counts_1year</span> <span class="op">&lt;-</span> <span class="fu">rbms</span><span class="fu">::</span><span class="fu"><a href="../reference/impute_count.html">impute_count</a></span><span class="op">(</span>ts_season_count<span class="op">=</span><span class="va">ts_season_count</span>, ts_flight_curve<span class="op">=</span><span class="va">pheno</span><span class="op">[</span><span class="va">M_YEAR</span> <span class="op">!=</span> <span class="fl">2001</span>, <span class="op">]</span>, YearLimit<span class="op">=</span> <span class="fl">1</span>, TimeUnit<span class="op">=</span><span class="st">'w'</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in FUN(X[[i]], ...): We used the flight curve of 2000 to compute</span></span>
<span><span class="co">## abundance indices for year 2001</span></span></code></pre>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">impt_counts_0year</span> <span class="op">&lt;-</span> <span class="fu">rbms</span><span class="fu">::</span><span class="fu"><a href="../reference/impute_count.html">impute_count</a></span><span class="op">(</span>ts_season_count<span class="op">=</span><span class="va">ts_season_count</span>, ts_flight_curve<span class="op">=</span><span class="va">pheno</span><span class="op">[</span><span class="va">M_YEAR</span> <span class="op">!=</span> <span class="fl">2001</span>, <span class="op">]</span>, YearLimit<span class="op">=</span> <span class="fl">0</span>, TimeUnit<span class="op">=</span><span class="st">'w'</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## No reliable flight curve available within a  0  year horizon of 2001</span></span></code></pre>
</div>
<div class="section level5">
<h5 id="site-and-collated-indices">
<strong>5.</strong> Site and collated indices<a class="anchor" aria-label="anchor" href="#site-and-collated-indices"></a>
</h5>
<p>From the imputed counts, the <code>site_index</code> function can be
used to calculate site index for each year and site. Only sites that
exceed a threshold for the proportional representation of the flight
curve are included. This threshold is set using the MinFC argument,
which In this example is 0.10.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sindex</span> <span class="op">&lt;-</span> <span class="fu">rbms</span><span class="fu">::</span><span class="fu"><a href="../reference/site_index.html">site_index</a></span><span class="op">(</span>butterfly_count <span class="op">=</span> <span class="va">impt_counts</span>, MinFC <span class="op">=</span> <span class="fl">0.10</span><span class="op">)</span></span></code></pre></div>
<p>From the site indices, estimates of the annual collated indices are
made using the <code><a href="../reference/collated_index.html">collated_index()</a></code> function. Collated indices
represents the mean total butterfly count expected on a BMS transect in
a given year. The function fits a Generalised Linear Model (GLM) with
site and years included as factorial independent variables. The
proportion of the flight curve is included as a GLM weight. When the
argument rm_zero is set to TRUE, all sites where the species are not
observed are filtered, speeding up the fit of the GLM without altering
the output.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">co_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/collated_index.html">collated_index</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sindex</span>, s_sp <span class="op">=</span> <span class="fl">2</span>, sindex_value <span class="op">=</span> <span class="st">"SINDEX"</span>, glm_weights <span class="op">=</span> <span class="cn">TRUE</span>, rm_zero <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">co_index</span></span></code></pre></div>
<pre><code><span><span class="co">## $col_index</span></span>
<span><span class="co">## Key: &lt;M_YEAR&gt;</span></span>
<span><span class="co">##    BOOTi M_YEAR NSITE NSITE_B NSITE_OBS COL_INDEX</span></span>
<span><span class="co">##    &lt;num&gt;  &lt;num&gt; &lt;int&gt;   &lt;int&gt;     &lt;int&gt;     &lt;num&gt;</span></span>
<span><span class="co">## 1:     0   2000   124     124       107  18.22935</span></span>
<span><span class="co">## 2:     0   2001   108     108       100  30.15065</span></span>
<span><span class="co">## 3:     0   2002   114     114       107  30.66658</span></span>
<span><span class="co">## 4:     0   2003   122     122       113  59.78319</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $site_id</span></span>
<span><span class="co">##   [1] "1"   "14"  "157" "158" "159" "160" "161" "162" "163" "164" "165" "166"</span></span>
<span><span class="co">##  [13] "15"  "167" "168" "169" "170" "171" "172" "173" "174" "175" "176" "16" </span></span>
<span><span class="co">##  [25] "177" "178" "179" "185" "193" "51"  "82"  "31"  "41"  "154" "19"  "180"</span></span>
<span><span class="co">##  [37] "181" "182" "187" "183" "184" "186" "21"  "23"  "24"  "25"  "26"  "27" </span></span>
<span><span class="co">##  [49] "2"   "28"  "29"  "30"  "32"  "34"  "36"  "37"  "39"  "42"  "43"  "3"  </span></span>
<span><span class="co">##  [61] "45"  "47"  "48"  "54"  "60"  "61"  "62"  "64"  "65"  "69"  "4"   "71" </span></span>
<span><span class="co">##  [73] "72"  "76"  "83"  "84"  "85"  "86"  "89"  "91"  "92"  "6"   "93"  "95" </span></span>
<span><span class="co">##  [85] "96"  "97"  "99"  "100" "101" "102" "104" "106" "8"   "107" "111" "112"</span></span>
<span><span class="co">##  [97] "113" "115" "116" "117" "118" "119" "120" "9"   "122" "123" "124" "126"</span></span>
<span><span class="co">## [109] "127" "128" "129" "130" "132" "133" "10"  "134" "135" "136" "137" "139"</span></span>
<span><span class="co">## [121] "140" "141" "142" "143" "144" "12"  "145" "146" "147" "148" "149" "150"</span></span>
<span><span class="co">## [133] "151" "153" "155" "156"</span></span></code></pre>
<p>The index can be transformed to a log(10) scale.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">co_index</span> <span class="op">&lt;-</span> <span class="va">co_index</span><span class="op">$</span><span class="va">col_index</span></span>
<span><span class="va">co_index_b</span> <span class="op">&lt;-</span> <span class="va">co_index</span><span class="op">[</span><span class="va">COL_INDEX</span> <span class="op">&gt;</span> <span class="fl">0.0001</span> <span class="op">&amp;</span> <span class="va">COL_INDEX</span> <span class="op">&lt;</span> <span class="fl">100000</span>, <span class="op">]</span></span>
<span><span class="va">co_index_logInd</span> <span class="op">&lt;-</span> <span class="va">co_index_b</span><span class="op">[</span><span class="va">BOOTi</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fu">.</span><span class="op">(</span><span class="va">M_YEAR</span>, <span class="va">COL_INDEX</span><span class="op">)</span><span class="op">]</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">COL_INDEX</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">M_YEAR</span><span class="op">]</span><span class="op">[</span>, <span class="va">mean_logInd</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">V1</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co">## merge the mean log index with the full bootstrap dataset</span></span>
<span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setattr.html" class="external-link">setnames</a></span><span class="op">(</span><span class="va">co_index_logInd</span>, <span class="st">"V1"</span>, <span class="st">"logInd"</span><span class="op">)</span>; <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">setkey</a></span><span class="op">(</span><span class="va">co_index_logInd</span>, <span class="va">M_YEAR</span><span class="op">)</span>; <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">setkey</a></span><span class="op">(</span><span class="va">co_index_b</span>, <span class="va">M_YEAR</span><span class="op">)</span></span>
<span><span class="va">co_index_b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">co_index_b</span>, <span class="va">co_index_logInd</span>, all.x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span></code></pre></div>
<p>The log scaled indices can be plotted. Here, we represent the data
with time-series average being centered to two
(i.e. <code>log10(100)</code>) as the standard for British time series
reporting.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">col_pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cyan4"</span>, <span class="st">"orange"</span>, <span class="st">"orangered2"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## compute the metric used for the graph of the Collated Log-Index centred around 2 (observed, bootstrap sample, credible confidence interval, linear trend)</span></span>
<span><span class="va">b1</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>M_YEAR <span class="op">=</span> <span class="va">co_index_b</span><span class="op">$</span><span class="va">M_YEAR</span>, LCI <span class="op">=</span> <span class="fl">2</span> <span class="op">+</span> <span class="va">co_index_b</span><span class="op">$</span><span class="va">logInd</span> <span class="op">-</span> <span class="va">co_index_b</span><span class="op">$</span><span class="va">mean_logInd</span><span class="op">)</span></span>
<span><span class="va">b2</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>M_YEAR <span class="op">=</span> <span class="va">co_index_b</span><span class="op">[</span><span class="va">BOOTi</span> <span class="op">==</span> <span class="fl">0</span>, <span class="va">M_YEAR</span><span class="op">]</span>, LCI<span class="op">=</span> <span class="fl">2</span> <span class="op">+</span> <span class="va">co_index_b</span><span class="op">[</span><span class="va">BOOTi</span> <span class="op">==</span> <span class="fl">0</span>, <span class="va">logInd</span><span class="op">]</span> <span class="op">-</span> <span class="va">co_index_b</span><span class="op">[</span><span class="va">BOOTi</span> <span class="op">==</span> <span class="fl">0</span>, <span class="va">mean_logInd</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lm_mod</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">LCI</span> <span class="op">~</span> <span class="va">M_YEAR</span>, data <span class="op">=</span> <span class="va">b2</span><span class="op">)</span>, silent<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create the initial plot with ggplot</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">b2</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">M_YEAR</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Adding the shaded area with white fill</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_rect</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, xmax <span class="op">=</span> <span class="cn">Inf</span>, ymin <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, ymax <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span>,</span>
<span>            fill <span class="op">=</span> <span class="st">"white"</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Adding the lines and points for non-missing LCI values</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">b2</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">LCI</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">LCI</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"grey70"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">LCI</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1.3</span>, color <span class="op">=</span> <span class="va">col_pal</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">b2</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">LCI</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">LCI</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">col_pal</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, shape <span class="op">=</span> <span class="fl">19</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Adding the horizontal line</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">2</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Adding labels and customizing axes</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"year"</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="st">'log '</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span><span class="op">*</span><span class="st">' Collated Index'</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">b2</span><span class="op">$</span><span class="va">M_YEAR</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Making the y-axis appear as a black line</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.line.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_line</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning: Using `size` aesthetic for lines was deprecated in ggplot2 3.4.0.</span></span>
<span><span class="co">## <span style="color: #00BBBB;">ℹ</span> Please use `linewidth` instead.</span></span>
<span><span class="co">## <span style="color: #555555;">This warning is displayed once every 8 hours.</span></span></span>
<span><span class="co">## <span style="color: #555555;">Call `lifecycle::last_lifecycle_warnings()` to see where this warning was</span></span></span>
<span><span class="co">## <span style="color: #555555;">generated.</span></span></span></code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Adding the regression line if lm_mod is not a try-error</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">lm_mod</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">!=</span> <span class="st">"try-error"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">lm_mod</span>, newdata <span class="op">=</span> <span class="va">b2</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"maroon4"</span>, size <span class="op">=</span> <span class="fl">1.5</span>, linetype <span class="op">=</span> <span class="st">"solid"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># show the plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="vignette_files/figure-html/ind_fig-1.png" alt="Collated index." width="700"><p class="caption">
Collated index.
</p>
</div>
</div>
<div class="section level5">
<h5 id="bootstrap-confidence-interval">
<strong>6.</strong> Bootstrap confidence interval<a class="anchor" aria-label="anchor" href="#bootstrap-confidence-interval"></a>
</h5>
<p>the <code><a href="../reference/boot_sample.html">boot_sample()</a></code> function can be used to compute a
confidence interval around the collated indices. A number of sites are
sampled (randomely, with resampling) a number of times, specified by the
argument, boot_n. This produces a distribution of the annual collated
indices, from which we can can derive the confidence intervals around
the collated indices. In this example, we set boot_n. to 200 samples,
but for a reliable confidence interval, k should be at least 1000. For
reproducibility, we use set.seed() to generate a repeatable random
sample</p>
<p><em>NOTE: You should not take large numbers of bootstraps from a
dataset with a small number of sites, as resampling sites will not
introduce new variance.</em></p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">218795</span><span class="op">)</span></span>
<span><span class="va">bootsample</span> <span class="op">&lt;-</span> <span class="fu">rbms</span><span class="fu">::</span><span class="fu"><a href="../reference/boot_sample.html">boot_sample</a></span><span class="op">(</span><span class="va">sindex</span>, boot_n <span class="op">=</span> <span class="fl">200</span><span class="op">)</span></span></code></pre></div>
<p>Using the <code><a href="../reference/collated_index.html">collated_index()</a></code> function in a loop, with
bootstrap samples informing the argument <code>boot_ind</code>, we can
now compute the boot_n number of collated indices over the entire
time-series.</p>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">co_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span><span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dim.html" class="external-link">dim</a></span><span class="op">(</span><span class="va">bootsample</span><span class="op">$</span><span class="va">boot_ind</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span> <span class="va">co_index</span><span class="op">[[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu">rbms</span><span class="fu">::</span><span class="fu"><a href="../reference/collated_index.html">collated_index</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">sindex</span>, s_sp <span class="op">=</span> <span class="fl">2</span>, sindex_value <span class="op">=</span> <span class="st">"SINDEX"</span>, bootID<span class="op">=</span><span class="va">i</span>, boot_ind<span class="op">=</span> <span class="va">bootsample</span>, glm_weights<span class="op">=</span><span class="cn">TRUE</span>, rm_zero<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># collate and append the results</span></span>
<span><span class="va">co_index</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/rbindlist.html" class="external-link">rbindlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">co_index</span>, FUN <span class="op">=</span> <span class="st">"[["</span>,<span class="st">"col_index"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Annual log indices, as well as their average, are then computed from
the original sample. To derive confidence intervals, we compute annual
log indices for each bootstrap sample.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">co_index_b</span> <span class="op">&lt;-</span> <span class="va">co_index</span><span class="op">[</span><span class="va">COL_INDEX</span> <span class="op">&gt;</span> <span class="fl">0.0001</span> <span class="op">&amp;</span> <span class="va">COL_INDEX</span> <span class="op">&lt;</span> <span class="fl">100000</span>, <span class="op">]</span></span>
<span><span class="va">co_index_logInd</span> <span class="op">&lt;-</span> <span class="va">co_index_b</span><span class="op">[</span><span class="va">BOOTi</span> <span class="op">==</span> <span class="fl">0</span>, <span class="fu">.</span><span class="op">(</span><span class="va">M_YEAR</span>, <span class="va">COL_INDEX</span><span class="op">)</span><span class="op">]</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">COL_INDEX</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">M_YEAR</span><span class="op">]</span><span class="op">[</span>, <span class="va">mean_logInd</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">V1</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co">## merge the mean log index with the full bootstrap dataset</span></span>
<span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setattr.html" class="external-link">setnames</a></span><span class="op">(</span><span class="va">co_index_logInd</span>, <span class="st">"V1"</span>, <span class="st">"logInd"</span><span class="op">)</span>; <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">setkey</a></span><span class="op">(</span><span class="va">co_index_logInd</span>, <span class="va">M_YEAR</span><span class="op">)</span>; <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">setkey</a></span><span class="op">(</span><span class="va">co_index_b</span>, <span class="va">M_YEAR</span><span class="op">)</span></span>
<span><span class="va">co_index_b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/merge.html" class="external-link">merge</a></span><span class="op">(</span><span class="va">co_index_b</span>, <span class="va">co_index_logInd</span>, all.x <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/setkey.html" class="external-link">setkey</a></span><span class="op">(</span><span class="va">co_index_b</span>, <span class="va">BOOTi</span>, <span class="va">M_YEAR</span><span class="op">)</span></span>
<span><span class="va">co_index_b</span><span class="op">[</span> , <span class="va">boot_logInd</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">COL_INDEX</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span><span class="op">]</span></span></code></pre></div>
<p>From the bootstrap samples, we can derive a 95% Confidence Interval,
using the corresponding percentiles (i.e., 0.025 and 0.975).</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">b1</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>M_YEAR <span class="op">=</span> <span class="va">co_index_b</span><span class="op">$</span><span class="va">M_YEAR</span>, LCI <span class="op">=</span> <span class="fl">2</span> <span class="op">+</span> <span class="va">co_index_b</span><span class="op">$</span><span class="va">boot_logInd</span> <span class="op">-</span> <span class="va">co_index_b</span><span class="op">$</span><span class="va">mean_logInd</span><span class="op">)</span></span>
<span><span class="va">b2</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://rdatatable.gitlab.io/data.table/reference/data.table.html" class="external-link">data.table</a></span><span class="op">(</span>M_YEAR <span class="op">=</span> <span class="va">co_index_b</span><span class="op">[</span><span class="va">BOOTi</span> <span class="op">==</span> <span class="fl">0</span>, <span class="va">M_YEAR</span><span class="op">]</span>, LCI<span class="op">=</span> <span class="fl">2</span> <span class="op">+</span> <span class="va">co_index_b</span><span class="op">[</span><span class="va">BOOTi</span> <span class="op">==</span> <span class="fl">0</span>, <span class="va">logInd</span><span class="op">]</span> <span class="op">-</span> <span class="va">co_index_b</span><span class="op">[</span><span class="va">BOOTi</span> <span class="op">==</span> <span class="fl">0</span>, <span class="va">mean_logInd</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="va">b5</span> <span class="op">&lt;-</span> <span class="va">b1</span><span class="op">[</span><span class="va">co_index_b</span><span class="op">$</span><span class="va">BOOTi</span> <span class="op">!=</span> <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">LCI</span>, <span class="fl">0.025</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">M_YEAR</span><span class="op">]</span></span>
<span><span class="va">b6</span> <span class="op">&lt;-</span> <span class="va">b1</span><span class="op">[</span><span class="va">co_index_b</span><span class="op">$</span><span class="va">BOOTi</span> <span class="op">!=</span> <span class="fl">0</span>, <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html" class="external-link">quantile</a></span><span class="op">(</span><span class="va">LCI</span>, <span class="fl">0.975</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, by <span class="op">=</span> <span class="va">M_YEAR</span><span class="op">]</span></span>
<span><span class="va">lm_mod</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/try.html" class="external-link">try</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/lm.html" class="external-link">lm</a></span><span class="op">(</span><span class="va">LCI</span> <span class="op">~</span> <span class="va">M_YEAR</span>, data <span class="op">=</span> <span class="va">b2</span><span class="op">)</span>, silent<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## define graph axis limits and color scheme</span></span>
<span><span class="va">yl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">b5</span><span class="op">$</span><span class="va">V1</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">ceiling</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">b6</span><span class="op">$</span><span class="va">V1</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">col_pal</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"cyan4"</span>, <span class="st">"orange"</span>, <span class="st">"orangered2"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert b5 and b6 to data frames for easier handling in ggplot</span></span>
<span><span class="va">b5_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">b5</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, y0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">b5</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">b6_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">b6</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, y1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">b6</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine b5 and b6 into a single data frame</span></span>
<span><span class="va">segments_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">b5_df</span>, <span class="va">b6_df</span><span class="op">)</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Convert b5 and b6 to data frames for easier handling in ggplot</span></span>
<span><span class="va">b5_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">b5</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, y0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">b5</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">b6_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>x1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">b6</span><span class="op">[</span>,<span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>, y1 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="va">b6</span><span class="op">[</span>,<span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Combine b5 and b6 into a single data frame</span></span>
<span><span class="va">segments_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">b5_df</span>, <span class="va">b6_df</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create the initial plot with ggplot</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">b2</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">M_YEAR</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Adding the shaded area with white fill</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_rect</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, xmax <span class="op">=</span> <span class="cn">Inf</span>, ymin <span class="op">=</span> <span class="op">-</span><span class="cn">Inf</span>, ymax <span class="op">=</span> <span class="cn">Inf</span><span class="op">)</span>,</span>
<span>            fill <span class="op">=</span> <span class="st">"white"</span>, alpha <span class="op">=</span> <span class="fl">0.2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Adding the segments</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_segment.html" class="external-link">geom_segment</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">segments_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x0</span>, y <span class="op">=</span> <span class="va">y0</span>, xend <span class="op">=</span> <span class="va">x1</span>, yend <span class="op">=</span> <span class="va">y1</span><span class="op">)</span>,</span>
<span>               color <span class="op">=</span> <span class="va">col_pal</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Adding the lines and points for non-missing LCI values</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">b2</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">LCI</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">LCI</span><span class="op">)</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span>, color <span class="op">=</span> <span class="st">"grey70"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">LCI</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">1.3</span>, color <span class="op">=</span> <span class="va">col_pal</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">b2</span>, <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">LCI</span><span class="op">)</span><span class="op">)</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">LCI</span><span class="op">)</span>, color <span class="op">=</span> <span class="va">col_pal</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, shape <span class="op">=</span> <span class="fl">19</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Adding the horizontal line</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html" class="external-link">geom_hline</a></span><span class="op">(</span>yintercept <span class="op">=</span> <span class="fl">2</span>, linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Adding labels and customizing axes</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"year"</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/expression.html" class="external-link">expression</a></span><span class="op">(</span><span class="st">'log '</span><span class="op">[</span><span class="fl">10</span><span class="op">]</span><span class="op">*</span><span class="st">' Collated Index'</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_x_continuous</a></span><span class="op">(</span>breaks <span class="op">=</span> <span class="va">b2</span><span class="op">$</span><span class="va">M_YEAR</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_cartesian.html" class="external-link">coord_cartesian</a></span><span class="op">(</span>ylim <span class="op">=</span> <span class="va">yl</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_minimal</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co"># Making the y-axis appear as a black line and setting the background color to white</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span></span>
<span>    panel.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_rect</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="st">"white"</span>, color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span>,</span>
<span>    axis.line.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_line</a></span><span class="op">(</span>color <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co"># Adding the regression line if lm_mod is not a try-error</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">lm_mod</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">!=</span> <span class="st">"try-error"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html" class="external-link">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">lm_mod</span>, newdata <span class="op">=</span> <span class="va">b2</span>, type <span class="op">=</span> <span class="st">"response"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"maroon4"</span>, size <span class="op">=</span> <span class="fl">1.5</span>, linetype <span class="op">=</span> <span class="st">"solid"</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Print the plot</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">p</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="vignette_files/figure-html/ind_fig_CI-1.png" alt="Collated index with 95% CI." width="700"><p class="caption">
Collated index with 95% CI.
</p>
</div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Reto Schmucki, Colin A. Harrower.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
